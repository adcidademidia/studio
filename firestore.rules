/**
 * @fileoverview Firestore Security Rules for the StreamDeck Lower Thirds application.
 *
 * Core Philosophy:
 * This ruleset prioritizes a strict user-ownership model for private data nested under `/users/{userId}`.
 * Global configurations (themes, lower third configurations) are stored at the root level and may be publicly readable.
 *
 * Data Structure:
 * - `/users/{userId}`: Root for all user-specific data.
 * - `/users/{userId}/lowerThirdInstances/{instanceId}`: Instances of lower thirds, owned by the user.
 * - `/themes/{themeId}`: Globally available themes.
 * - `/lowerThirdConfigurations/{configurationId}`: Globally available configurations.
 *
 * Key Security Decisions:
 * - Strict user-ownership: Only the authenticated user can read, create, update, or delete data under their `/users/{userId}` path.
 * - Global configurations: Themes and configurations are publicly readable to allow StreamDeck to list the contents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their own profile document if request.auth.uid == 'user123'.
     * @deny (create) User with UID 'user456' cannot create a profile document for 'user123'.
     * @principle Enforces user-ownership.
     */
    match /users/{userId} {
      allow get: if false;
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /users/{userId}/lowerThirdInstances/{instanceId} collection.
     * @path /users/{userId}/lowerThirdInstances/{instanceId}
     * @allow (create) User with UID 'user123' can create a lowerThirdInstance document under their own user ID.
     * @deny (create) User with UID 'user456' cannot create a lowerThirdInstance document under 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/lowerThirdInstances/{instanceId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.id == instanceId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /themes/{themeId} collection.
     * @path /themes/{themeId}
     * @allow (get) Any user can retrieve a theme.
     * @allow (list) Any user can list themes.
     * @deny (create) No user can create a theme.  Themes can only be created by administrator.
     * @principle Allows public read access to themes.
     */
    match /themes/{themeId} {
      allow get: if true;
      allow list: if true;

      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /lowerThirdConfigurations/{configurationId} collection.
     * @path /lowerThirdConfigurations/{configurationId}
     * @allow (get) Any user can retrieve a lower third configuration.
     * @allow (list) Any user can list lower third configurations.
     * @deny (create) No user can create a lower third configuration. Configurations can only be created by administrator.
     * @principle Allows public read access to configurations.
     */
    match /lowerThirdConfigurations/{configurationId} {
      allow get: if true;
      allow list: if true;

      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}